services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: es-orders
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - esdata:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  es-init:
    image: curlimages/curl:8.5.0
    container_name: es-init-orders
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ./elasticsearch/index-mapping.json:/mapping.json:ro
    environment:
      - ES_NODE=http://elasticsearch:9200
      - ES_INDEX=orders
    entrypoint: ["/bin/sh", "-c"]
    command: >
      echo "Ensuring index '$$ES_INDEX'..." &&
      if curl -fsS "$$ES_NODE/$$ES_INDEX" >/dev/null 2>&1; then
        echo "Index exists. Skipping.";
      else
        echo "Creating index '$$ES_INDEX' from mapping.json..." &&
        curl -fsS -X PUT "$$ES_NODE/$$ES_INDEX"
          -H "Content-Type: application/json"
          --data-binary @/mapping.json &&
        echo "" && echo "Done.";
      fi

  server1:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: server1-dotnet
    environment:
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "8080:8080"

  server2:
    build:
      context: ./server_screen_2
      dockerfile: Dockerfile
    container_name: server2-node
    environment:
      - PORT=3001
      - ES_NODE=http://elasticsearch:9200
      - ES_INDEX=orders
    ports:
      - "3001:3001"
    depends_on:
      elasticsearch:
        condition: service_healthy

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: client-react
    ports:
      - "3000:80"
    depends_on:
      - server1
      - server2

volumes:
  esdata:
